import fs from 'fs';
import path from 'path';
import sharp from 'sharp';

const baseDir = './public/assets/images';

const sizes = [
  { suffix: '-big', width: 1200, quality: 80 },
  { suffix: '-medium', width: 700, quality: 80 },
  { suffix: '-small', width: 400, quality: 75 },
];

async function processImage(filePath) {
  const ext = path.extname(filePath);
  const base = filePath.replace(ext, '');
  let success = true;

  for (const size of sizes) {
    const outFile = `${base}${size.suffix}${ext}`;

    try {
      await sharp(filePath)
        .resize({ width: size.width })
        .webp({ quality: size.quality })
        .toFile(outFile);

      console.log(`âœ… Created/Overwritten: ${outFile}`);
    } catch (err) {
      success = false;
      console.error(`âŒ Error processing ${filePath}:`, err);
    }
  }

  // LÃ¶sche Originaldatei nur, wenn alle GrÃ¶ÃŸen erfolgreich erstellt wurden
  if (success) {
    try {
      fs.unlinkSync(filePath);
      console.log(`ðŸ—‘ï¸ Deleted original file: ${filePath}`);
    } catch (err) {
      console.error(`âŒ Failed to delete original file: ${filePath}`, err);
    }
  }
}

function walkFolder(folder) {
  const items = fs.readdirSync(folder);

  items.forEach(item => {
    const fullPath = path.join(folder, item);
    const stat = fs.statSync(fullPath);

    if (stat.isDirectory()) {
      walkFolder(fullPath);
    } else if (stat.isFile()) {
      // PrÃ¼fe, dass der Name NICHT -small, -medium oder -big enthÃ¤lt
      const fileName = path.basename(fullPath);
      if (!/-small|-medium|-big/.test(fileName)) {
        processImage(fullPath);
      }
    }
  });
}

console.log("ðŸš€ Starte Bildverarbeitung â€¦");
walkFolder(baseDir);
console.log("ðŸ¥³ Fertig!");

