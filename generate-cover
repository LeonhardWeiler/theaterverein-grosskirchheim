#!/bin/bash

BASE_DIR="./public/assets/images"
COVER_JSON="./src/data/cover.json"
DEFAULT_BASE="0001"
TARGET_BASE="0001"

for folder in "$BASE_DIR"/*; do
  [ -d "$folder" ] || continue

  folderName=$(basename "$folder")
  IMAGES_DIR="$folder/images"
  COVER_DIR="$folder/cover"

  if [ -d "$IMAGES_DIR" ]; then
    echo "Verarbeite $IMAGES_DIR ..."

    # Cover-Ordner erstellen und leeren
    mkdir -p "$COVER_DIR"
    rm -f "$COVER_DIR"/*

    # Basis aus cover.json holen, sonst Default
    baseFromJson=$(jq -r --arg key "$folderName" '.[$key] // empty' "$COVER_JSON")

    if [ -n "$baseFromJson" ]; then
      sourceBase="$baseFromJson"
      echo "Cover aus JSON: $sourceBase"
    else
      sourceBase="$DEFAULT_BASE"
      echo "Kein JSON-Eintrag, nutze Default: $sourceBase"
    fi

    # Varianten kopieren und umbenennen
    for variant in small medium big; do
      srcFile="$IMAGES_DIR/${sourceBase}-${variant}.webp"
      destFile="$COVER_DIR/${TARGET_BASE}-${variant}.webp"

      if [ -f "$srcFile" ]; then
        cp -v "$srcFile" "$destFile"
      else
        echo "Fehlt: $srcFile"
      fi
    done
  fi
done

echo "Fertig!"

